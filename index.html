<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nature Defender: Endless Siege</title>
    <style>
        :root { --primary: #00ff41; --bg: #050a05; --panel: rgba(0, 40, 0, 0.9); }
        body { margin: 0; background: var(--bg); color: var(--primary); font-family: 'Segoe UI', Tahoma, sans-serif; display: flex; flex-direction: column; align-items: center; overflow: hidden; }
        
        /* UI OVERLAY */
        #ui-top { width: 100%; display: flex; justify-content: space-around; padding: 15px; background: var(--panel); border-bottom: 2px solid #003300; box-shadow: 0 0 20px rgba(0,255,0,0.1); z-index: 10; }
        .stat-box { text-align: center; }
        .stat-val { font-size: 24px; font-weight: 800; color: #fff; display: block; }

        canvas { background: #111d11; border: 3px solid #004400; cursor: crosshair; margin-top: 10px; image-rendering: pixelated; }

        #shop { position: absolute; bottom: 20px; background: var(--panel); padding: 15px; border-radius: 12px; border: 1px solid var(--primary); display: flex; gap: 20px; }
        .btn { background: #002200; border: 1px solid var(--primary); color: var(--primary); padding: 10px 20px; cursor: pointer; border-radius: 5px; transition: 0.2s; }
        .btn:hover { background: var(--primary); color: #000; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; }

        #notif { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 60px; font-weight: 900; pointer-events: none; opacity: 0; transition: 0.5s; text-shadow: 0 0 20px #000; }
    </style>
</head>
<body>

<div id="ui-top">
    <div class="stat-box">WAVE<span id="wave-val" class="stat-val">1</span></div>
    <div class="stat-box">RESOURCES<span id="money-val" class="stat-val">$250</span></div>
    <div class="stat-box">BASE INTEGRITY<span id="life-val" class="stat-val">100%</span></div>
</div>

<div id="notif">WAVE 1</div>
<canvas id="game"></canvas>

<div id="shop">
    <button class="btn" onclick="setTool('basic')">BASIC TURRET ($50)</button>
    <button class="btn" onclick="setTool('sniper')">SNIPER ($120)</button>
    <button class="btn" onclick="setTool('nuke')" id="nuke-btn">NUKE ($500)</button>
</div>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    canvas.width = 1000;
    canvas.height = 600;

    // --- GAME STATE ---
    let money = 250;
    let lives = 20;
    let wave = 0;
    let tool = 'basic';
    let enemies = [];
    let towers = [];
    let bullets = [];
    let particles = [];
    let isSpawning = false;

    // Path Coordinates
    const path = [{x:-50,y:300}, {x:200,y:300}, {x:200,y:100}, {x:500,y:100}, {x:500,y:500}, {x:800,y:500}, {x:800,y:300}, {x:1050,y:300}];

    // --- ENEMY LOGIC ---
    class Enemy {
        constructor(type, level) {
            this.level = level;
            this.progress = 0;
            this.pathIndex = 0;
            this.x = path[0].x;
            this.y = path[0].y;
            
            const stats = {
                reg:   { hp: 60 * Math.pow(1.2, level),  speed: 2,   color: '#00ff41', size: 18, bounty: 10 },
                fast:  { hp: 30 * Math.pow(1.2, level),  speed: 4.5, color: '#00ccff', size: 12, bounty: 15 },
                tank:  { hp: 400 * Math.pow(1.2, level), speed: 1,   color: '#ffaa00', size: 30, bounty: 40 },
                boss:  { hp: 2500 * Math.pow(1.3, level),speed: 0.7, color: '#ffffff', size: 55, bounty: 250 }
            }[type];

            Object.assign(this, stats);
            this.maxHp = this.hp;
        }

        update() {
            let target = path[this.pathIndex + 1];
            let dx = target.x - this.x;
            let dy = target.y - this.y;
            let dist = Math.sqrt(dx*dx + dy*dy);

            if (dist < 5) {
                this.pathIndex++;
                if (this.pathIndex >= path.length - 1) return true; // Reached end
            }

            this.x += (dx/dist) * this.speed;
            this.y += (dy/dist) * this.speed;
            return false;
        }

        draw() {
            ctx.fillStyle = this.color;
            ctx.shadowBlur = 10; ctx.shadowColor = this.color;
            ctx.fillRect(this.x - this.size/2, this.y - this.size/2, this.size, this.size);
            ctx.shadowBlur = 0;
            
            // HP Bar
            ctx.fillStyle = '#222'; ctx.fillRect(this.x - 20, this.y - this.size, 40, 5);
            ctx.fillStyle = this.color; ctx.fillRect(this.x - 20, this.y - this.size, 40 * (this.hp/this.maxHp), 5);
        }
    }

    // --- TOWER LOGIC ---
    class Tower {
        constructor(x, y, type) {
            this.x = x; this.y = y; this.type = type;
            this.level = 1;
            const config = {
                basic:  { range: 150, fireRate: 20, dmg: 15,  color: '#008800' },
                sniper: { range: 400, fireRate: 80, dmg: 120, color: '#0044ff' }
            }[type];
            Object.assign(this, config);
            this.cooldown = 0;
        }

        update() {
            if (this.cooldown > 0) this.cooldown--;
            else {
                let target = enemies.find(e => Math.hypot(e.x - this.x, e.y - this.y) < this.range);
                if (target) {
                    bullets.push({x: this.x, y: this.y, tx: target.x, ty: target.y, life: 5, color: this.color});
                    target.hp -= this.dmg;
                    this.cooldown = this.fireRate;
                    spawnParticles(target.x, target.y, this.color);
                }
            }
        }

        draw() {
            ctx.fillStyle = this.color;
            ctx.beginPath(); ctx.arc(this.x, this.y, 20, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = 'rgba(0,255,0,0.05)';
            ctx.beginPath(); ctx.arc(this.x, this.y, this.range, 0, Math.PI*2); ctx.stroke();
        }
    }

    // --- UTILITIES ---
    function spawnParticles(x, y, color) {
        for(let i=0; i<5; i++) particles.push({x, y, vx: (Math.random()-0.5)*5, vy: (Math.random()-0.5)*5, life: 20, color});
    }

    function setTool(t) { 
        if(t === 'nuke' && money >= 500) {
            money -= 500;
            enemies = [];
            spawnParticles(500, 300, '#ff0000');
            updateUI();
        } else { tool = t; }
    }

    async function startWave() {
        if (isSpawning) return;
        wave++;
        isSpawning = true;
        
        const n = document.getElementById('notif');
        n.innerText = `WAVE ${wave}`; n.style.opacity = 1;
        setTimeout(() => n.style.opacity = 0, 2000);

        let count = 8 + wave * 4;
        for (let i = 0; i < count; i++) {
            let type = 'reg';
            if (wave > 2 && Math.random() > 0.7) type = 'fast';
            if (wave > 5 && Math.random() > 0.8) type = 'tank';
            if (wave % 5 === 0 && i === count - 1) type = 'boss';
            
            enemies.push(new Enemy(type, wave));
            await new Promise(r => setTimeout(r, 800 - Math.min(wave*20, 500)));
        }
        isSpawning = false;
    }

    canvas.addEventListener('mousedown', (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left) * (canvas.width / rect.width);
        const y = (e.clientY - rect.top) * (canvas.height / rect.height);
        
        let cost = tool === 'basic' ? 50 : 120;
        if (money >= cost) {
            towers.push(new Tower(x, y, tool));
            money -= cost;
            updateUI();
        }
    });

    function updateUI() {
        document.getElementById('money-val').innerText = `$${money}`;
        document.getElementById('life-val').innerText = `${Math.max(0, lives * 5)}%`;
        document.getElementById('wave-val').innerText = wave;
    }

    function loop() {
        ctx.fillStyle = '#050a05'; ctx.fillRect(0,0,canvas.width, canvas.height);
        
        // Draw Path
        ctx.strokeStyle = '#0a1a0a'; ctx.lineWidth = 60; ctx.lineJoin = 'round';
        ctx.beginPath(); ctx.moveTo(path[0].x, path[0].y);
        path.forEach(p => ctx.lineTo(p.x, p.y)); ctx.stroke();

        if (enemies.length === 0 && !isSpawning) startWave();

        // Update Systems
        enemies.forEach((e, i) => {
            if (e.update()) { enemies.splice(i, 1); lives--; updateUI(); }
            if (e.hp <= 0) { money += e.bounty; updateUI(); enemies.splice(i, 1); }
            else e.draw();
        });

        towers.forEach(t => { t.update(); t.draw(); });

        bullets.forEach((b, i) => {
            ctx.strokeStyle = b.color; ctx.lineWidth = 3;
            ctx.beginPath(); ctx.moveTo(b.x, b.y); ctx.lineTo(b.tx, b.ty); ctx.stroke();
            b.life--; if(b.life <= 0) bullets.splice(i, 1);
        });

        particles.forEach((p, i) => {
            p.x += p.vx; p.y += p.vy; p.life--;
            ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, 3, 3);
            if(p.life <= 0) particles.splice(i, 1);
        });

        if (lives > 0) requestAnimationFrame(loop);
        else { ctx.fillStyle="white"; ctx.font="80px Arial"; ctx.fillText("SYSTEM COLLAPSE", 150, 350); }
    }

    updateUI();
    loop();
</script>
</body>
</html>
